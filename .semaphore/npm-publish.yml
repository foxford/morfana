version: v1.0
name: npm publish pipeline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:
  - name: ðŸ›³ Publish at npm
    task:
      secrets:
        - name: npm-token
      jobs:
        - name: Publish at npm
          commands:
            - checkout
            - sem-version node $(cat .nvmrc)
            - node --version
            - npm --version
            - cache restore npm-cache
            - cache restore node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-$SEMAPHORE_GIT_BRANCH,node-modules-master
            - npm run build
            - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> .npmrc
            - source ./tools/scripts/npm-tag.sh # set current tag
            - npx zx ./tools/scripts/npm-publish.mjs
            - rm -rf .npmrc
